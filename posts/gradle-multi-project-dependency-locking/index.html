<!doctype html><html data-theme=light lang=en-us><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Dependency Locking in Gradle Multi-Project setup | António Almeida</title><link rel=stylesheet href=https://antonioalmeida.github.io/css/styles.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#aa0000><meta name=msapplication-TileColor content="#000000"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.2.0/css/all.css integrity=sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.3.1.js integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin=anonymous></script><link rel=alternate type=application/rss+xml href=https://antonioalmeida.github.io/feed.xml title="António Almeida"><div class=container><nav class="navbar level"><div class=navbar-brand><div><a class=nav-item href=https://antonioalmeida.github.io><span class="title is-4">~/</span></a>
<a class=nav-item href=https://antonioalmeida.github.io/posts><span class="title is-4">posts</span></a>
<a class=nav-item href=https://antonioalmeida.github.io/posts/gradle-multi-project-dependency-locking><span class="title is-4">/gradle-multi-project-dependency-locking</span></a></div></div><div class="navbar-menu has-text-centered is-active"><div class="navbar-end is-centered"><a href=https://github.com/antonioalmeida rel=me><span class=icon><i></i></span></a><a href=https://bsky.app/profile/xu.pt rel=me><span class=icon><i></i></span></a><a href=https://linkedin.com/in/theantonioalmeida rel=me><span class=icon><i></i></span></a><a href=https://antonioalmeida.github.io/cv.pdf rel=me><span class=icon><i></i></span></a></div></div></nav></div><div class=container><div class=content><h2 class="subtitle is-6">May 23, 2024</h2><h1 class="subtitle is-size-4-mobile is-size-3-desktop">Dependency Locking in Gradle Multi-Project setup</h1><p>It&rsquo;s good practice to lock dependency versions when building software.</p><p>In Gradle projects locking is achieved by generating and maintaining a <code>gradle.lockfile</code> as dependencies are updated. It&rsquo;s relatively easy to configure it for a single build project, i.e., single <code>build.gradle</code> file.</p><p>When using Gradle Multi-Project, it&rsquo;s more complicated. From Gradle&rsquo;s <a href=https://docs.gradle.org/8.4/userguide/dependency_locking.html#lock_all_configurations_in_one_build_execution>dependency locking documentation</a>:</p><blockquote><p>&ldquo;Note that in a multi project setup, <code>dependencies</code> only is executed on one project, the root one in this case.&rdquo;</p></blockquote><p>I can&rsquo;t find any official dependency locking solution for Multi-Project setups, so created a script to address it.</p><h2 id=usage>Usage</h2><ol><li>On your root <code>build.gradle</code>, enable dependency locking on all <code>subprojects</code>:</li></ol><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=color:#998;font-style:italic>// (...) 
</span><span style=color:#998;font-style:italic></span>
subprojects <span style=color:#000;font-weight:700>{</span> subproject <span style=color:#000;font-weight:700>-&gt;</span>
    <span style=color:#998;font-style:italic>// (...)
</span><span style=color:#998;font-style:italic></span>
    dependencyLocking <span style=color:#000;font-weight:700>{</span>
        lockAllConfigurations<span style=color:#000;font-weight:700>()</span>
    <span style=color:#000;font-weight:700>}</span>
    
    <span style=color:#998;font-style:italic>// (...)
</span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>}</span>
</code></pre></div><ol start=2><li>Create an initial lock state (source for script <a href=#appendix>below</a>):</li></ol><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sh dependencies-write-locks.sh
</code></pre></div><p>This will run <code>./gradlew dependencies --write-locks</code> per project, therefore creating a <code>gradle.lockfile</code> per Gradle project.</p><p>Now, whenever you update or add a dependency, <code>dependencies-write-locks.sh</code> must be run to update the lockfiles. You should add them to Git.</p><h3 id=remarks>Remarks</h3><ul><li>Protip: run <code>./gradlew projects</code> to list your subprojects</li><li>Is there a Gradle plugin that does this? I&rsquo;ll maybe create one if there isn&rsquo;t</li><li>Thanks to <a href=https://www.cramhacks.com/p/gradle-multi-project-lockfiles>Kyle Kelly</a> for inspiration</li></ul><h3 id=appendix>Appendix</h3><p>Source for <code>dependencies-write-locks.sh</code></p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#999;font-weight:700;font-style:italic>#!/bin/bash
</span><span style=color:#999;font-weight:700;font-style:italic></span>
<span style=color:#998;font-style:italic># Capture the gradle projects as a variable</span>
<span style=color:teal>project_names</span><span style=color:#000;font-weight:700>=</span><span style=color:#000;font-weight:700>$(</span>./gradlew projects | grep <span style=color:#d14>&#39;Project&#39;</span> | awk -F<span style=color:#d14>&#34;&#39;&#34;</span> <span style=color:#d14>&#39;{print $2}&#39;</span><span style=color:#000;font-weight:700>)</span>

<span style=color:#000;font-weight:700>for</span> project in <span style=color:teal>$project_names</span>; <span style=color:#000;font-weight:700>{</span>
  ./gradlew <span style=color:teal>$project</span>:dependencies --write-locks
<span style=color:#000;font-weight:700>}</span>

<span style=color:#0086b3>echo</span> <span style=color:#d14>&#34;Updated gradle.lockfiles for </span><span style=color:#000;font-weight:700>$(</span><span style=color:#0086b3>echo</span> <span style=color:teal>$project_names</span> | wc -w<span style=color:#000;font-weight:700>)</span><span style=color:#d14> projects&#34;</span>
</code></pre></div></div></div><div class="container has-text-centered"></div><section class=section><div class="container has-text-centered"><h6>&copy; António Almeida</a> 2024</h6></div></section>